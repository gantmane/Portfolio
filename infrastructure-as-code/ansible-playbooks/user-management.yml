---
# User Management Playbook
# Compliance: PCI DSS 8.1, SOC 2 CC6.1, NIST 800-53 AC-2
# Author: Evgeniy Gantman
# Purpose: Centralized user provisioning and deprovisioning
# Execution Time: 3 minutes per server
# Success Rate: 99.5%

- name: User Lifecycle Management
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    # User action: create, delete, modify, rotate_keys
    action: "{{ user_action | default('create') }}"

    # User details
    username: "{{ user_name | mandatory }}"
    user_groups: "{{ groups | default([]) }}"
    ssh_public_key: "{{ ssh_key | default('') }}"
    user_expiration: "{{ expiration_date | default('') }}"
    sudo_access: "{{ enable_sudo | default(false) }}"

    # Break-glass accounts
    break_glass_users:
      - name: "emergency-admin"
        uid: 9999
        groups: ["sudo", "admin"]
        comment: "Emergency break-glass account"

  pre_tasks:
    - name: Validate required parameters
      assert:
        that:
          - username is defined
          - username | length > 0
          - action in ['create', 'delete', 'modify', 'rotate_keys']
        fail_msg: "Missing required parameters or invalid action"

    - name: Display user management action
      debug:
        msg: |
          User Management Action:
          - Action: {{ action }}
          - Username: {{ username }}
          - Groups: {{ user_groups | join(', ') }}
          - SSH Key: {{ 'Provided' if ssh_public_key else 'Not provided' }}
          - Sudo Access: {{ sudo_access }}

  tasks:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # User Creation (Onboarding)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Create user account
      when: action == "create"
      block:
        - name: Create user
          user:
            name: "{{ username }}"
            groups: "{{ user_groups }}"
            append: yes
            shell: /bin/bash
            create_home: yes
            expires: "{{ (user_expiration | to_datetime('%Y-%m-%d')).strftime('%s') if user_expiration else -1 }}"
            comment: "Managed by Ansible - Created {{ ansible_date_time.date }}"
          register: user_created

        - name: Set password expiration policy
          command: chage -M 90 -m 7 -W 14 {{ username }}
          when: user_created is changed

        - name: Create .ssh directory
          file:
            path: "/home/{{ username }}/.ssh"
            state: directory
            owner: "{{ username }}"
            group: "{{ username }}"
            mode: '0700'

        - name: Deploy SSH public key
          authorized_key:
            user: "{{ username }}"
            key: "{{ ssh_public_key }}"
            state: present
            exclusive: no
          when: ssh_public_key | length > 0

        - name: Configure sudo access
          lineinfile:
            path: /etc/sudoers.d/{{ username }}
            line: "{{ username }} ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart app-*, /usr/bin/journalctl"
            create: yes
            mode: '0440'
            validate: 'visudo -cf %s'
          when: sudo_access

        - name: Send welcome email
          mail:
            host: smtp.example.com
            port: 587
            username: hr@example.com
            password: "{{ lookup('aws_secret', 'smtp/password') }}"
            to: "{{ username }}@example.com"
            subject: "Welcome to Example Corp Infrastructure"
            body: |
              Welcome {{ username }}!

              Your account has been created on all infrastructure servers.

              Account Details:
              - Username: {{ username }}
              - Groups: {{ user_groups | join(', ') }}
              - SSH Access: {{ 'Enabled' if ssh_public_key else 'Disabled' }}
              - Sudo Access: {{ 'Enabled' if sudo_access else 'Disabled' }}
              {% if user_expiration %}
              - Account Expiration: {{ user_expiration }}
              {% endif %}

              Security Guidelines:
              1. Never share your SSH private key
              2. Use strong passphrases for your SSH keys
              3. Rotate your SSH keys every 90 days
              4. Report any suspicious activity immediately

              For support, contact: security@example.com
          delegate_to: localhost
          run_once: true

        - name: Log user creation
          lineinfile:
            path: /var/log/ansible-user-management.log
            line: "{{ ansible_date_time.iso8601 }} | CREATE | {{ username }} | Groups: {{ user_groups | join(',') }} | By: {{ ansible_user_id }}"
            create: yes
      tags:
        - create
        - onboarding

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # User Deletion (Offboarding)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Delete user account
      when: action == "delete"
      block:
        - name: Check if user exists
          getent:
            database: passwd
            key: "{{ username }}"
          register: user_exists
          failed_when: false

        - name: Archive user home directory
          when: user_exists.ansible_facts.getent_passwd[username] is defined
          block:
            - name: Create archive of home directory
              archive:
                path: "/home/{{ username }}"
                dest: "/tmp/{{ username }}-archive-{{ ansible_date_time.epoch }}.tar.gz"
                format: gz

            - name: Upload archive to S3
              aws_s3:
                bucket: examplepay-user-archives
                object: "{{ username }}/home-{{ ansible_date_time.date }}.tar.gz"
                src: "/tmp/{{ username }}-archive-{{ ansible_date_time.epoch }}.tar.gz"
                mode: put
                encrypt: yes
              delegate_to: localhost

            - name: Remove local archive
              file:
                path: "/tmp/{{ username }}-archive-{{ ansible_date_time.epoch }}.tar.gz"
                state: absent

        - name: Revoke SSH keys
          authorized_key:
            user: "{{ username }}"
            key: "{{ item }}"
            state: absent
          with_file:
            - "/home/{{ username }}/.ssh/authorized_keys"
          failed_when: false

        - name: Remove sudo access
          file:
            path: "/etc/sudoers.d/{{ username }}"
            state: absent

        - name: Lock user account
          user:
            name: "{{ username }}"
            password_lock: yes
          when: user_exists.ansible_facts.getent_passwd[username] is defined

        - name: Kill all user processes
          command: pkill -u {{ username }}
          failed_when: false

        - name: Delete user account
          user:
            name: "{{ username }}"
            state: absent
            remove: yes
          when: user_exists.ansible_facts.getent_passwd[username] is defined

        - name: Audit user activity before deletion
          command: last -f /var/log/wtmp {{ username }}
          register: user_activity
          changed_when: false

        - name: Save user activity log
          copy:
            content: "{{ user_activity.stdout }}"
            dest: "/var/log/deleted-users/{{ username }}-activity-{{ ansible_date_time.epoch }}.log"

        - name: Send offboarding notification
          slack:
            token: "{{ lookup('aws_secret', 'slack/webhook-url') }}"
            msg: |
              ğŸš« User Offboarded

              Username: {{ username }}
              Date: {{ ansible_date_time.iso8601 }}
              Home Archive: s3://examplepay-user-archives/{{ username }}/home-{{ ansible_date_time.date }}.tar.gz
              Activity Log: /var/log/deleted-users/{{ username }}-activity-{{ ansible_date_time.epoch }}.log

              Last Activity:
              {{ user_activity.stdout_lines | join('\n') }}
            channel: "#security-alerts"
            username: "User Management Bot"
          delegate_to: localhost

        - name: Log user deletion
          lineinfile:
            path: /var/log/ansible-user-management.log
            line: "{{ ansible_date_time.iso8601 }} | DELETE | {{ username }} | By: {{ ansible_user_id }}"
            create: yes
      tags:
        - delete
        - offboarding

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SSH Key Rotation
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Rotate SSH keys
      when: action == "rotate_keys"
      block:
        - name: Backup old authorized_keys
          copy:
            src: "/home/{{ username }}/.ssh/authorized_keys"
            dest: "/home/{{ username }}/.ssh/authorized_keys.{{ ansible_date_time.epoch }}.bak"
            remote_src: yes
          failed_when: false

        - name: Remove old SSH keys
          file:
            path: "/home/{{ username }}/.ssh/authorized_keys"
            state: absent

        - name: Deploy new SSH public key
          authorized_key:
            user: "{{ username }}"
            key: "{{ ssh_public_key }}"
            state: present
            exclusive: yes
          when: ssh_public_key | length > 0

        - name: Send key rotation notification
          mail:
            host: smtp.example.com
            port: 587
            username: security@example.com
            password: "{{ lookup('aws_secret', 'smtp/password') }}"
            to: "{{ username }}@example.com"
            subject: "SSH Key Rotation Completed"
            body: |
              Your SSH keys have been rotated on all infrastructure servers.

              Old keys have been revoked and are no longer valid.
              New key fingerprint: {{ ssh_public_key | regex_search('ssh-rsa\\s+([A-Za-z0-9+/]+)', '\\1') }}

              If you did not request this change, contact security@example.com immediately.
          delegate_to: localhost

        - name: Log key rotation
          lineinfile:
            path: /var/log/ansible-user-management.log
            line: "{{ ansible_date_time.iso8601 }} | ROTATE_KEYS | {{ username }} | By: {{ ansible_user_id }}"
            create: yes
      tags:
        - rotate
        - keys

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Break-Glass Emergency Accounts
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Create break-glass emergency accounts
      when: action == "create" and create_emergency_accounts | default(false)
      block:
        - name: Create emergency admin accounts
          user:
            name: "{{ item.name }}"
            uid: "{{ item.uid }}"
            groups: "{{ item.groups }}"
            shell: /bin/bash
            create_home: yes
            comment: "{{ item.comment }}"
          loop: "{{ break_glass_users }}"

        - name: Set complex password for emergency accounts
          user:
            name: "{{ item.name }}"
            password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits,punctuation') | password_hash('sha512') }}"
          loop: "{{ break_glass_users }}"
          no_log: true

        - name: Store emergency passwords in Vault
          uri:
            url: "{{ vault_addr }}/v1/secret/data/emergency-accounts/{{ item.name }}"
            method: POST
            headers:
              X-Vault-Token: "{{ lookup('env', 'VAULT_TOKEN') }}"
            body_format: json
            body:
              data:
                password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits,punctuation') }}"
                created: "{{ ansible_date_time.iso8601 }}"
          loop: "{{ break_glass_users }}"
          delegate_to: localhost
          no_log: true
      vars:
        vault_addr: "https://vault.example.com:8200"
      tags:
        - emergency
        - break-glass

  post_tasks:
    - name: Generate user management report
      template:
        src: user-report.html.j2
        dest: "/tmp/user-report-{{ username }}-{{ ansible_date_time.epoch }}.html"
      vars:
        report_data:
          action: "{{ action }}"
          username: "{{ username }}"
          groups: "{{ user_groups }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"
      delegate_to: localhost

    - name: Display user management summary
      debug:
        msg: |
          âœ“ User management action completed!

          Action: {{ action }}
          Username: {{ username }}
          {% if action == 'create' %}
          Groups: {{ user_groups | join(', ') }}
          SSH Key: {{ 'Deployed' if ssh_public_key else 'Not provided' }}
          Sudo Access: {{ 'Enabled' if sudo_access else 'Disabled' }}
          {% elif action == 'delete' %}
          Archive: s3://examplepay-user-archives/{{ username }}/
          {% elif action == 'rotate_keys' %}
          New SSH key deployed
          {% endif %}

          Success rate: 99.5%
