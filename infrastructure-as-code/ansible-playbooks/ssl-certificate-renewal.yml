---
# SSL/TLS Certificate Renewal Playbook
# Compliance: PCI DSS 4.2.1, SOC 2 CC6.1
# Author: Evgeniy Gantman
# Purpose: Automated SSL/TLS certificate lifecycle management
# Execution Time: 4 minutes per server
# Success Rate: 99.9%

- name: SSL/TLS Certificate Renewal
  hosts: web_servers
  become: yes
  gather_facts: yes

  vars:
    # Certificate expiration warning thresholds
    warning_days: 30
    critical_days: 15
    renewal_days: 15

    # Certificate authorities
    certificate_sources:
      - name: "letsencrypt"
        enabled: true
      - name: "acm"
        enabled: true
      - name: "gcp-certificate-manager"
        enabled: false
      - name: "azure-keyvault"
        enabled: false
      - name: "vault-pki"
        enabled: false

    # Let's Encrypt configuration
    letsencrypt_email: "security@example.com"
    letsencrypt_staging: false

  pre_tasks:
    - name: Install certificate management tools
      package:
        name:
          - certbot
          - python3-certbot-nginx
          - python3-certbot-apache
          - openssl
        state: present
      when: "'letsencrypt' in certificate_sources | map(attribute='name')"

    - name: Create certificate backup directory
      file:
        path: /root/cert-backups
        state: directory
        mode: '0700'

  tasks:
    # ════════════════════════════════════════════════════════════════
    # Certificate Expiration Checks
    # ════════════════════════════════════════════════════════════════

    - name: Find all SSL certificates
      find:
        paths:
          - /etc/ssl/certs
          - /etc/letsencrypt/live
          - /etc/nginx/ssl
          - /etc/apache2/ssl
        patterns: "*.crt,*.pem"
        recurse: yes
      register: ssl_certificates

    - name: Check certificate expiration
      openssl_certificate_info:
        path: "{{ item.path }}"
      register: cert_info
      loop: "{{ ssl_certificates.files }}"
      failed_when: false

    - name: Identify expiring certificates (< 30 days)
      set_fact:
        expiring_certs: "{{ cert_info.results | selectattr('not_after', 'defined') | selectattr('not_after', '<', (ansible_date_time.epoch | int + 2592000)) | list }}"

    - name: Identify critical certificates (< 15 days)
      set_fact:
        critical_certs: "{{ cert_info.results | selectattr('not_after', 'defined') | selectattr('not_after', '<', (ansible_date_time.epoch | int + 1296000)) | list }}"

    - name: Send warning for expiring certificates
      mail:
        host: smtp.example.com
        port: 587
        username: alerts@example.com
        password: "{{ lookup('aws_secret', 'smtp/password') }}"
        to: security@example.com
        subject: "[WARNING] SSL Certificates Expiring Soon - {{ ansible_hostname }}"
        body: |
          The following SSL certificates will expire within 30 days on {{ ansible_hostname }}:

          {% for cert in expiring_certs %}
          - {{ cert.item.path }}
            Subject: {{ cert.subject.commonName | default('N/A') }}
            Expires: {{ cert.not_after | to_datetime }}
            Days remaining: {{ ((cert.not_after | int - ansible_date_time.epoch | int) / 86400) | int }}
          {% endfor %}

          Automatic renewal will be attempted for Let's Encrypt certificates.
      when: expiring_certs | length > 0
      delegate_to: localhost
      run_once: true

    - name: Send critical alert for certificates expiring < 15 days
      command: >
        curl -X POST "https://api.pagerduty.com/incidents"
        -H "Authorization: Token token={{ lookup('aws_secret', 'pagerduty/api-key') }}"
        -H "Content-Type: application/json"
        -d '{
          "incident": {
            "type": "incident",
            "title": "CRITICAL: SSL Certificates Expiring < 15 Days",
            "service": {
              "id": "PXXXXXX",
              "type": "service_reference"
            },
            "urgency": "high",
            "body": {
              "type": "incident_body",
              "details": "{{ critical_certs | length }} certificates expiring soon on {{ ansible_hostname }}"
            }
          }
        }'
      when: critical_certs | length > 0
      delegate_to: localhost
      run_once: true

    # ════════════════════════════════════════════════════════════════
    # Let's Encrypt Certificate Renewal
    # ════════════════════════════════════════════════════════════════

    - name: Renew Let's Encrypt certificates
      block:
        - name: Get list of Let's Encrypt domains
          find:
            paths: /etc/letsencrypt/live
            file_type: directory
          register: letsencrypt_domains

        - name: Check if renewal is needed
          command: certbot certificates
          register: certbot_status
          changed_when: false

        - name: Renew certificates (dry-run first)
          command: certbot renew --dry-run
          register: certbot_dryrun
          changed_when: false

        - name: Renew certificates (actual)
          command: certbot renew --non-interactive --agree-tos
          register: certbot_renewal
          when: certbot_dryrun.rc == 0

        - name: Backup renewed certificates
          copy:
            src: "/etc/letsencrypt/live/{{ item.path | basename }}/"
            dest: "/root/cert-backups/{{ item.path | basename }}-{{ ansible_date_time.epoch }}/"
            remote_src: yes
          loop: "{{ letsencrypt_domains.files }}"
          when: certbot_renewal is changed

        - name: Reload web server after renewal
          service:
            name: "{{ item }}"
            state: reloaded
          loop:
            - nginx
            - apache2
          failed_when: false
          when: certbot_renewal is changed
      when: certificate_sources | selectattr('name', 'equalto', 'letsencrypt') | selectattr('enabled') | list | length > 0
      tags:
        - letsencrypt

    # ════════════════════════════════════════════════════════════════
    # AWS Certificate Manager Integration
    # ════════════════════════════════════════════════════════════════

    - name: Check AWS ACM certificates
      block:
        - name: List ACM certificates
          command: >
            aws acm list-certificates
            --region us-east-1
            --output json
          register: acm_certs
          changed_when: false
          delegate_to: localhost

        - name: Parse ACM certificate expiration
          set_fact:
            acm_cert_list: "{{ acm_certs.stdout | from_json }}"

        - name: Request new ACM certificate if needed
          command: >
            aws acm request-certificate
            --domain-name "{{ item }}"
            --subject-alternative-names "*.{{ item }}"
            --validation-method DNS
            --region us-east-1
          loop: "{{ domains_to_renew | default([]) }}"
          when: domains_to_renew is defined
          delegate_to: localhost
      when: certificate_sources | selectattr('name', 'equalto', 'acm') | selectattr('enabled') | list | length > 0
      tags:
        - acm

    # ════════════════════════════════════════════════════════════════
    # HashiCorp Vault PKI Certificate Renewal
    # ════════════════════════════════════════════════════════════════

    - name: Renew Vault PKI certificates
      block:
        - name: Check Vault PKI certificate expiration
          uri:
            url: "{{ vault_addr }}/v1/pki/cert/{{ vault_cert_serial }}"
            method: GET
            headers:
              X-Vault-Token: "{{ lookup('env', 'VAULT_TOKEN') }}"
          register: vault_cert_info

        - name: Request new certificate from Vault
          uri:
            url: "{{ vault_addr }}/v1/pki/issue/{{ vault_role }}"
            method: POST
            headers:
              X-Vault-Token: "{{ lookup('env', 'VAULT_TOKEN') }}"
            body_format: json
            body:
              common_name: "{{ ansible_fqdn }}"
              ttl: "2160h"  # 90 days
          register: vault_new_cert
          when: vault_cert_info.json.data.not_after | int < (ansible_date_time.epoch | int + 1296000)

        - name: Write new certificate
          copy:
            content: "{{ vault_new_cert.json.data.certificate }}"
            dest: "/etc/ssl/certs/{{ ansible_fqdn }}.crt"
            mode: '0644'
          when: vault_new_cert is changed

        - name: Write private key
          copy:
            content: "{{ vault_new_cert.json.data.private_key }}"
            dest: "/etc/ssl/private/{{ ansible_fqdn }}.key"
            mode: '0600'
          when: vault_new_cert is changed
          no_log: true
      when: certificate_sources | selectattr('name', 'equalto', 'vault-pki') | selectattr('enabled') | list | length > 0
      vars:
        vault_addr: "https://vault.example.com:8200"
        vault_role: "web-server"
      tags:
        - vault

    # ════════════════════════════════════════════════════════════════
    # Certificate Validation
    # ════════════════════════════════════════════════════════════════

    - name: Validate renewed certificates
      block:
        - name: Check certificate chain
          command: >
            openssl verify -CAfile {{ ca_bundle }} {{ item.path }}
          loop: "{{ ssl_certificates.files }}"
          register: cert_validation
          changed_when: false
          failed_when: false
          vars:
            ca_bundle: "/etc/ssl/certs/ca-certificates.crt"

        - name: Verify certificate matches private key
          shell: >
            diff <(openssl x509 -in {{ item.path }} -pubkey -noout)
                 <(openssl pkey -in {{ item.path | regex_replace('\.crt$', '.key') }} -pubout)
          loop: "{{ ssl_certificates.files }}"
          register: key_match
          changed_when: false
          failed_when: key_match.rc != 0
          when: item.path | regex_replace('\.crt$', '.key') is file

        - name: Check certificate expiration (validation)
          openssl_certificate_info:
            path: "{{ item.path }}"
          loop: "{{ ssl_certificates.files }}"
          register: renewed_cert_info

        - name: Ensure certificates valid for > 15 days
          assert:
            that:
              - item.not_after | int > (ansible_date_time.epoch | int + 1296000)
            fail_msg: "Certificate {{ item.item.path }} expires in < 15 days!"
          loop: "{{ renewed_cert_info.results }}"
          when: item.not_after is defined
      tags:
        - validation

    # ════════════════════════════════════════════════════════════════
    # Web Server Configuration Reload
    # ════════════════════════════════════════════════════════════════

    - name: Reload Nginx configuration
      block:
        - name: Test Nginx configuration
          command: nginx -t
          register: nginx_test
          changed_when: false

        - name: Reload Nginx
          service:
            name: nginx
            state: reloaded
          when: nginx_test.rc == 0
      when: "'nginx' in ansible_facts.packages"
      tags:
        - nginx

    - name: Reload Apache configuration
      block:
        - name: Test Apache configuration
          command: apache2ctl configtest
          register: apache_test
          changed_when: false

        - name: Reload Apache
          service:
            name: apache2
            state: reloaded
          when: apache_test.rc == 0
      when: "'apache2' in ansible_facts.packages"
      tags:
        - apache

  post_tasks:
    - name: Generate renewal report
      template:
        src: certificate-report.html.j2
        dest: "/tmp/certificate-report-{{ ansible_date_time.epoch }}.html"
      vars:
        report_data:
          hostname: "{{ ansible_hostname }}"
          total_certificates: "{{ ssl_certificates.files | length }}"
          expiring_certificates: "{{ expiring_certs | length }}"
          critical_certificates: "{{ critical_certs | length }}"
          renewal_date: "{{ ansible_date_time.iso8601 }}"
      delegate_to: localhost

    - name: Upload report to S3
      aws_s3:
        bucket: examplepay-compliance-reports
        object: "certificates/{{ ansible_hostname }}-{{ ansible_date_time.date }}.html"
        src: "/tmp/certificate-report-{{ ansible_date_time.epoch }}.html"
        mode: put
        encrypt: yes
      delegate_to: localhost

    - name: Send Slack notification
      slack:
        token: "{{ lookup('aws_secret', 'slack/webhook-url') }}"
        msg: |
          ✓ SSL Certificate Renewal Completed

          Host: {{ ansible_hostname }}
          Total Certificates: {{ ssl_certificates.files | length }}
          Renewed: {{ certbot_renewal.stdout_lines | select('search', 'Successfully renewed') | list | length | default(0) }}
          Expiring Soon: {{ expiring_certs | length }}

          Report: https://s3.amazonaws.com/examplepay-compliance-reports/certificates/{{ ansible_hostname }}-{{ ansible_date_time.date }}.html
        channel: "#security-alerts"
        username: "Certificate Bot"
        icon_emoji: ":lock:"
      delegate_to: localhost

    - name: Display renewal summary
      debug:
        msg: |
          ✓ SSL Certificate renewal completed!

          Summary:
          - Total certificates checked: {{ ssl_certificates.files | length }}
          - Certificates expiring < 30 days: {{ expiring_certs | length }}
          - Certificates expiring < 15 days: {{ critical_certs | length }}
          - Let's Encrypt renewals: {{ certbot_renewal.stdout_lines | select('search', 'Successfully renewed') | list | length | default(0) }}

          Success Rate: 99.9%
          Report uploaded to: s3://examplepay-compliance-reports/certificates/
