---
# Custom Falco Rules for ExamplePay Infrastructure
# Author: Evgeniy Gantman
# Purpose: Runtime threat detection for PCI DSS compliant Kubernetes clusters

# ============================================================================
# MACROS - Reusable rule components
# ============================================================================

- macro: container
  condition: (container.id != host)

- macro: spawned_process
  condition: (evt.type = execve and evt.dir=<)

- macro: shell_procs
  condition: (proc.name in (bash, sh, zsh, csh, ksh, dash))

- macro: sensitive_files
  condition: >
    (fd.name startswith /etc/shadow or
     fd.name startswith /etc/sudoers or
     fd.name startswith /root/.ssh/ or
     fd.name startswith /root/.aws/credentials or
     fd.name = /etc/pam.d/common-password)

- macro: user_sensitive_files
  condition: >
    (fd.name contains .ssh/id_rsa or
     fd.name contains .ssh/id_dsa or
     fd.name contains .aws/credentials or
     fd.name contains .kube/config)

- macro: bin_dir
  condition: fd.directory in (/bin, /sbin, /usr/bin, /usr/sbin)

- macro: etc_dir
  condition: fd.name startswith /etc

- macro: package_mgmt_procs
  condition: (proc.name in (apt, apt-get, dpkg, yum, rpm, apk, pip, npm, gem))

- macro: sensitive_mount
  condition: >
    (fd.name startswith /proc or
     fd.name startswith /sys or
     fd.name startswith /dev)

- macro: outbound_conn
  condition: (syscall.type=connect and evt.dir=< and fd.typechar=4)

- macro: inbound_conn
  condition: (syscall.type=accept and evt.dir=<)

- macro: allowed_dev_files
  condition: >
    (fd.name in (/dev/null, /dev/stdin, /dev/stdout, /dev/stderr,
     /dev/random, /dev/urandom, /dev/tty, /dev/pts/0))

# PCI DSS specific macros
- macro: cardholder_data_location
  condition: (fd.name startswith /var/data/cardholder)

- macro: pci_scope_container
  condition: (container.image.repository contains "payment" or k8s.ns.name = "pci-scope")

# ============================================================================
# RULES - Threat Detection
# ============================================================================

# ----------------------------------------------------------------------------
# CRITICAL SEVERITY - Container Breakout & Privilege Escalation
# ----------------------------------------------------------------------------

- rule: Terminal Shell in Container
  desc: Detect shell spawned inside a container (potential breakout attempt)
  condition: >
    spawned_process and container
    and shell_procs
    and proc.tty != 0
    and container_entrypoint
    and not user_expected_terminal_shell_in_container_conditions
  output: >
    CRITICAL: Shell spawned in container (user=%user.name user_uid=%user.uid
    user_loginuid=%user.loginuid process=%proc.name proc_exepath=%proc.exepath
    parent=%proc.pname command=%proc.cmdline terminal=%proc.tty
    container_id=%container.id container_name=%container.name
    image=%container.image.repository:%container.image.tag)
  priority: CRITICAL
  tags: [container, shell, mitre_execution]

- rule: Launch Privileged Container
  desc: Detect privileged container launch
  condition: >
    container_started and container
    and container.privileged=true
    and not user_privileged_containers
  output: >
    CRITICAL: Privileged container started (user=%user.name
    container_id=%container.id container_name=%container.name
    image=%container.image.repository:%container.image.tag)
  priority: CRITICAL
  tags: [container, privilege_escalation]

- rule: Container Mounting Sensitive Host Paths
  desc: Detect containers mounting sensitive host directories
  condition: >
    container_started
    and container.mount.dest[/] = "/" or
    container.mount.dest[/etc] = "/etc" or
    container.mount.dest[/var/run/docker.sock] = "/var/run/docker.sock"
  output: >
    CRITICAL: Container mounting sensitive host path (user=%user.name
    mount_dest=%container.mount.dest mount_source=%container.mount.source
    container=%container.name image=%container.image.repository)
  priority: CRITICAL
  tags: [container, breakout]

- rule: Kernel Module Load in Container
  desc: Detect kernel module loading from container
  condition: >
    spawned_process and container
    and (proc.name in (insmod, modprobe))
  output: >
    CRITICAL: Kernel module load attempted from container (user=%user.name
    command=%proc.cmdline container=%container.name)
  priority: CRITICAL
  tags: [container, kernel, breakout]

- rule: Set Setuid or Setgid bit
  desc: Detect setuid/setgid bit being set on file
  condition: >
    syscall.type = chmod or syscall.type = fchmod
    and (evt.arg.mode contains "S_ISUID" or evt.arg.mode contains "S_ISGID")
    and not proc.name in (dpkg, rpm)
  output: >
    CRITICAL: Setuid/Setgid bit set (user=%user.name file=%fd.name
    command=%proc.cmdline container=%container.name)
  priority: CRITICAL
  tags: [privilege_escalation, persistence]

# ----------------------------------------------------------------------------
# HIGH SEVERITY - Suspicious Process Activity
# ----------------------------------------------------------------------------

- rule: Reverse Shell
  desc: Detect reverse shell execution patterns
  condition: >
    spawned_process and container
    and ((proc.cmdline contains "bash -i" and proc.cmdline contains "/dev/tcp") or
         (proc.cmdline contains "nc" and proc.cmdline contains "-e") or
         (proc.cmdline contains "python" and proc.cmdline contains "socket") or
         (proc.cmdline contains "perl -e" and proc.cmdline contains "socket"))
  output: >
    HIGH: Reverse shell detected (user=%user.name command=%proc.cmdline
    container=%container.name parent=%proc.pname)
  priority: ERROR
  tags: [shell, c2, mitre_command_control]

- rule: Package Management in Container
  desc: Detect package manager execution in running container
  condition: >
    spawned_process and container
    and package_mgmt_procs
    and not package_mgmt_ancestor_procs
  output: >
    HIGH: Package management tool executed in container (user=%user.name
    process=%proc.name command=%proc.cmdline container=%container.name
    image=%container.image.repository)
  priority: ERROR
  tags: [process, software]

- rule: Cryptocurrency Miner Detected
  desc: Detect cryptocurrency mining processes
  condition: >
    spawned_process and
    ((proc.name in (xmrig, ethminer, minerd, cryptonight_miner, cpuminer)) or
     (proc.cmdline contains "stratum+tcp" and (proc.cmdline contains "xmr" or proc.cmdline contains "eth")) or
     (proc.cmdline contains "--donate-level"))
  output: >
    CRITICAL: Cryptocurrency miner detected (process=%proc.name
    cmdline=%proc.cmdline user=%user.name container=%container.name
    parent=%proc.pname)
  priority: CRITICAL
  tags: [process, cryptocurrency, malware]

- rule: Compiler Executed in Container
  desc: Detect compiler execution in runtime container
  condition: >
    spawned_process and container
    and (proc.name in (gcc, g++, cc, make, cmake, javac))
    and not user_known_compile_container
  output: >
    HIGH: Compiler executed in container (user=%user.name process=%proc.name
    command=%proc.cmdline container=%container.name)
  priority: ERROR
  tags: [process, software]

# ----------------------------------------------------------------------------
# HIGH SEVERITY - File System Tampering
# ----------------------------------------------------------------------------

- rule: Write Below Etc
  desc: Detect file modifications in /etc directory
  condition: >
    evt.type = open and evt.is_open_write = true and fd.typechar = 'f'
    and etc_dir
    and not proc.name in (dpkg, rpm, apt, yum, systemd, chef-client, puppet)
  output: >
    HIGH: File below /etc opened for writing (user=%user.name command=%proc.cmdline
    file=%fd.name parent=%proc.pname container=%container.name)
  priority: ERROR
  tags: [filesystem, mitre_persistence]

- rule: Write Below Binary Dir
  desc: Detect writes to system binary directories
  condition: >
    evt.type = open and evt.is_open_write = true and bin_dir
    and not proc.name in (dpkg, rpm, apt-get, yum)
  output: >
    HIGH: File in binary directory opened for writing (user=%user.name
    file=%fd.name command=%proc.cmdline container=%container.name)
  priority: ERROR
  tags: [filesystem, persistence]

- rule: Read Sensitive File
  desc: Detect reads of sensitive files
  condition: >
    evt.type = open and evt.is_open_read = true
    and sensitive_files
    and not proc.name in (sshd, systemd, auditd)
  output: >
    HIGH: Sensitive file opened for reading (user=%user.name file=%fd.name
    command=%proc.cmdline container=%container.name parent=%proc.pname)
  priority: ERROR
  tags: [filesystem, credentials]

- rule: User SSH Key Access
  desc: Detect access to user SSH private keys
  condition: >
    evt.type = open and user_sensitive_files
    and not proc.name in (ssh, scp, ssh-agent)
  output: >
    HIGH: User SSH key or cloud credential accessed (user=%user.name
    file=%fd.name process=%proc.name command=%proc.cmdline
    container=%container.name)
  priority: ERROR
  tags: [credentials, cloud]

# ----------------------------------------------------------------------------
# MEDIUM SEVERITY - Network Activity
# ----------------------------------------------------------------------------

- rule: Outbound Connection to C2 Server
  desc: Detect connections to known C2 server IPs
  condition: >
    outbound_conn
    and fd.sip in (known_c2_ips)
  output: >
    HIGH: Outbound connection to known C2 server (user=%user.name
    connection=%fd.name process=%proc.name command=%proc.cmdline
    container=%container.name)
  priority: ERROR
  tags: [network, c2]

- rule: Unexpected Outbound Connection
  desc: Detect unexpected outbound connections from containers
  condition: >
    outbound_conn and container
    and not allowed_outbound_destinations
  output: >
    MEDIUM: Unexpected outbound connection (user=%user.name
    connection=%fd.name destination=%fd.sip:%fd.sport process=%proc.name
    container=%container.name)
  priority: WARNING
  tags: [network]

# ----------------------------------------------------------------------------
# PCI DSS SPECIFIC RULES
# ----------------------------------------------------------------------------

- rule: Unauthorized Access to Cardholder Data
  desc: Detect unauthorized access to PCI scope cardholder data
  condition: >
    evt.type = open
    and cardholder_data_location
    and not proc.name in (authorized_payment_app, payment_processor)
  output: >
    CRITICAL: Unauthorized access to cardholder data (user=%user.name
    file=%fd.name process=%proc.name command=%proc.cmdline
    container=%container.name namespace=%k8s.ns.name)
  priority: CRITICAL
  tags: [pci_dss, data_access]

- rule: PCI Scope Container Network Connection
  desc: Monitor all network connections from PCI scope containers
  condition: >
    (outbound_conn or inbound_conn)
    and pci_scope_container
  output: >
    INFO: Network connection in PCI scope container (user=%user.name
    connection=%fd.name process=%proc.name container=%container.name
    namespace=%k8s.ns.name)
  priority: INFO
  tags: [pci_dss, network, audit]

- rule: System Log Tampering
  desc: Detect modifications to system logs (PCI DSS 10.5.2)
  condition: >
    evt.type = open and evt.is_open_write = true
    and fd.name startswith /var/log
    and not proc.name in (syslog, rsyslog, systemd-journal, fluentd)
  output: >
    CRITICAL: System log file modified (user=%user.name file=%fd.name
    process=%proc.name command=%proc.cmdline container=%container.name)
  priority: CRITICAL
  tags: [pci_dss, audit, log_tampering]

# ============================================================================
# EXCEPTIONS & WHITELISTS
# ============================================================================

- list: known_c2_ips
  items: []  # Populate from threat intelligence

- list: user_privileged_containers
  items: [falco, node-exporter, fluentd]

- macro: user_expected_terminal_shell_in_container_conditions
  condition: (k8s.ns.name = "development" or container.image.repository contains "debug")

- macro: user_known_compile_container
  condition: (k8s.ns.name = "ci-cd" or container.image.repository contains "builder")

- macro: package_mgmt_ancestor_procs
  condition: (proc.pname in (apt, dpkg, rpm, yum, pip, npm))

- macro: allowed_outbound_destinations
  condition: >
    (fd.sip in (allowed_external_ips) or
     fd.sport in (443, 80, 53))

- list: allowed_external_ips
  items: ["10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]

- list: authorized_payment_app
  items: [payment-service, card-processor]
